# Build with docker buid --build-arg="MAKEFILE=Makefile" to change the default.

FROM debian:stable-slim as builder
RUN apt-get update && apt-get install -y build-essential \ 
    gnutls-dev pkg-config libpcre3-dev git vim libdb-dev  sudo

ARG MAKEFILE="Makefile.afl"
ENV MAKEFILE=${MAKEFILE}

RUN apt-get install -y afl++ clang

RUN adduser --disabled-password exim


WORKDIR /build
COPY . .

# Choose only one of Makefile.afl or Makefile
# afl build separate because it seems default build does not use CC
RUN /bin/bash -c "./build-code.sh ${MAKEFILE}"

EXPOSE 25
CMD ["/usr/exim/bin/exim", "-bs", "-v"]
